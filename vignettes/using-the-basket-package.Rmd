---
title: "Using the basket Package"
author: "Nan Chen, Brian Hobbs, and Michael J. Kane"
date: "`r Sys.Date()`"
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
  word_document: default
vignette: 
  %\VignetteIndexEntry{Using the basket Package} 
  %\VignetteEngine{knitr::rmarkdown} 
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The "basket" package is an R package that can be applied to conduct basket trial designs basked on the MEM method. One can use the package to perform the exact or MCMC computation of the operating characteristics of different scenarios. The posterior probabilities, HPD boundaries, effective sample sizes (ESS), mean and median estimations can be calculated With this package using the MEM method. After the basket trial is completed, one can use the package conduct the MEM analysis with the observed outcomes. Density of eack basket and the exchangeability can be plotted using the package. The package includes the following main functions: 

- mem_full_bayes_exact
- mem_full_bayes_mcmc
- summary
- update_result
- plot_density
- plot_posterior_exchangeability
- plot_all_exchangeability


## mem_full_bayes_exact() function

This function conducts the exact computation based on the MEM method.
```{r}
library(basket)
data(vemu_wide)
baskets <- 1:5
vemu_wide1 <- vemu_wide[baskets,]
# Full Bayes exact method
exact_res <- mem_full_bayes_exact(responses = vemu_wide1$responders, 
                     size = vemu_wide1$evaluable,
                     name = vemu_wide1$baskets, p0=rep(0.15, length(basket)))
```
The output "exact_res" is a list including three components:  call, basketwise, clusterwise.

The "call" is the exact call including parameters for the function. 
```{r}
print(exact_res$call)
```

The "basketwise" includes all results of the basketwise analyses.

```{r}
print(exact_res$basketwise$PEP)
print(exact_res$basketwise$MAP)
print(exact_res$basketwise$post.prob)
print(exact_res$basketwise$HPD)
print(exact_res$basketwise$ESS)
print(exact_res$basketwise$mean_est)
print(exact_res$basketwise$median_est)
```
The "clusterwise" includes all results of the clusterwise analyses.
```{r}
print(exact_res$clusterwise$cluster)
print(exact_res$clusterwise$post.prob)
print(exact_res$clusterwise$HPD)
print(exact_res$clusterwise$ESS)
print(exact_res$clusterwise$mean_est)
print(exact_res$clusterwise$median_est)

```


## mem_full_bayes_mcmc() function

This function conducts the MCMC computation based on the MEM method.

```{r}
baskets <- 1:6
vemu_wide2 <- vemu_wide[baskets,]

MHResult1 <- mem_full_bayes_mcmc(responses = vemu_wide2$responders, 
                                 size = vemu_wide2$evaluable,
                                 name=c("NSCLC ","CRC.v ","CRC.vc","  BD  ","ED.LH "," ATC  "),
                                 p0 = c(0.15, 0.15, 0.15, 0.2, 0.15, 0.15), Initial = NA)

```

The output of the MCMC method "MHResult1" is a list including three components:  call, basketwise, clusterwise.

```{r}
print(MHResult1$call)

print(MHResult1$basketwise$PEP)
print(MHResult1$basketwise$MAP)
print(MHResult1$basketwise$post.prob)
print(MHResult1$basketwise$HPD)
print(MHResult1$basketwise$ESS)
print(MHResult1$basketwise$mean_est)
print(MHResult1$basketwise$median_est)


print(MHResult1$clusterwise$cluster)
print(MHResult1$clusterwise$post.prob)
print(MHResult1$clusterwise$HPD)
print(MHResult1$clusterwise$ESS)
print(MHResult1$clusterwise$mean_est)
print(MHResult1$clusterwise$median_est)
```

## summary() function

Summarize the operating characteristics from the result (basketwise or clusterwise)

```{r}

summary(exact_res$basketwise)
summary(exact_res$clusterwise)
```


## update_result() function

Update the result with the new threshold value p0 and the alternative parameter.

```{r}
exact_resNew <- update_result(exact_res, 0.25)

summary(exact_res$basketwise)
summary(exact_resNew$basketwise)

```

## plot functions
Plot the density and the exchaneability

```{r, fig.height = 3, fig.width= 4, fig.align= "center", message=FALSE,warning=FALSE}

plot_density(exact_res$basketwise)
```

```{r, message=FALSE,warning=FALSE, out.width='80%',fig.width=8, fig.height=4, fig.align= "center", results='hide'}

plot_posterior_exchangeability(exact_res$basketwise,
                               text_size=2.5, basket_name_hoffset=-0.2)
```

Plot prior, likelihood, and posterior probability.
```{r, message=FALSE,warning=FALSE, results='hide', out.width='100%',fig.width= 12, fig.height=6, fig.align= "center"}

plot_all_exchangeability(exact_res$basketwise, c("PRIOR", "MAP", "PEP"), 
                         text_size=2.5, basket_name_hoffset=-0.2)
```
```{r, results='hide', message=FALSE,warning=FALSE, out.width='80%',fig.width= 8, fig.height=5,fig.align= "center", fig.}
plot_all_exchangeability(exact_res$basketwise, c("MAP", "PEP"),
                         text_size=3, basket_name_hoffset=-0.2)
`````


